/* Cyclistic Case Study (Google Big Query + Tableau) */

/* Confirm ride_id values are unique */
SELECT ride_id
FROM `general-432301.wip.tripdata_test` 
WHERE ride_id IS NULL

SELECT COUNT(DISTINCT ride_id)
FROM `general-432301.wip.tripdata_test` 

SELECT ride_id
COUNT(ride_id) as count_ride_id
FROM `general-432301.wip.tripdata_test`
GROUP BY ride_id
ORDER BY count_ride_id desc


/* Remove all start_station_ids that are NULL */


/* Remove all start_station_ids are NULL or ' 'values */

/* Remove all start_lat, start_lng, end_lat, and end_lng with NULL or ' ' values. */

/* Remove all trip durations that were 60 seconds or less which could indicate they could have been false starts or users trying to redock their bikes */

/* Remove all trip durations that were over a day (86400 seconds) */

/* Applied consistent formatting to the started_at and ended_at columns */ 

/* Check that each ride_id key is unique and 16 characters long */

/* Check that all members are either 'member' or 'casual' */

/* Check that the bike types are either 'classic', 'electric', or 'docked' */

/* Check that each station has 1 name, 1 longitatude and 1 latitude */

/* Created six new columns: start_dayofweek, start_month, start_am_pm, start_hour, trip_duration, and distance_in_meters to conduct deeper analysis. */

/*  Check start_station_id */
SELECT  
  start_station_id,
  COUNT(DISTINCT start_station_name) as start_station_name_count
FROM `general-432301.wip.tripdata_test` 
GROUP BY
  start_station_id
ORDER BY 
  start_station_name_count DESC

/* Filter start_station_id by */
SELECT  
  DISTINCT start_station_name as station_name,
FROM `general-432301.wip.tripdata_test` 
WHERE
  start_station_id = '647'
ORDER BY
  station_name ASC

/* Cleaned data */
SELECT  ride_id,
MAX(rideable_type) as rideable_type,
MAX(started_at) as started_at,
MAX(ended_at) as ended_at,
MAX(D1.station_name ) as start_station_name,
MAX(start_station_id) as start_station_id,
MAX(D2.station_name) as end_station_name,
MAX(end_station_id) as end_station_id,
MAX(D1.lat) as start_lat,
MAX(D1.lng) as start_lng,
MAX(D2.lat) as end_lat,
MAX(D2.lng) as end_lng,
MAX(member_casual) as member_casual,
 FROM
(SELECT
  ride_id,
MAX(rideable_type) as rideable_type,
MAX(started_at) as started_at,
MAX(ended_at) as ended_at,
MAX(start_station_name) as start_station_name,
MAX(start_station_id) as start_station_id,
MAX(end_station_name) as end_station_name,
MAX(end_station_id) as end_station_id,
MAX(start_lat) as start_lat,
MAX(start_lng) as start_lng,
MAX(end_lat) as end_lat,
MAX(end_lng) as end_lng,
MAX(member_casual) as member_casual,

FROM
  `general-432301.wip.tripdata_test` GROUP BY ride_id) Q1
LEFT OUTER JOIN
  `general-432301.wip.dim_station` D1 
ON 
  Q1.start_station_id = D1.station_id

  LEFT OUTER JOIN
  `general-432301.wip.dim_station` D2
ON
  Q1.end_station_id = D2.station_id

  GROUP BY ride_id


/* Ride count */
SELECT  
  start_station_id,  
  MAX(start_station_name) as start_station_name,
  COUNT(DISTINCT ride_id) as ride_count,  
FROM `general-432301.wip.view_trip_data_report` 
WHERE 
  start_station_id IS NOT NULL 
GROUP BY
  start_station_id


/* Final trip data table - connect to Tableau */
SELECT  
  ride_id, 
  rideable_type, 
  member_casual,
  started_at, 
  ended_at, 
  CONCAT(FORMAT_DATETIME('%u', started_at),"-",FORMAT_DATETIME('%a', started_at)) as      
  start_dayofweek,
  FORMAT_DATETIME('%G', started_at) as start_year_id,
  CONCAT(FORMAT_DATETIME('%m', started_at),"-",FORMAT_DATETIME('%h', started_at)) as start_month,
  FORMAT_DATETIME('%P', started_at) as start_am_pm,
  EXTRACT(HOUR FROM started_at) as start_hour,
  start_station_id, 
  start_station_name, 
  end_station_id, 
  end_station_name, 
  start_lat, 
  start_lng,
  end_lat, 
  end_lng, 
  DATETIME_DIFF(ended_at, started_at, second) as trip_duration,
  ST_DISTANCE(ST_GEOGPOINT(start_lng, start_lat), ST_GEOGPOINT(end_lng, end_lat)) as    
  distance_in_meters

FROM `general-432301.wip.trip_data_clean` 
